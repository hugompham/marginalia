services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - '5173:5173'
    volumes:
      # Source code (read-only for HMR)
      - ./src:/app/src:ro
      - ./static:/app/static:ro
      # Config files
      - ./svelte.config.js:/app/svelte.config.js:ro
      - ./vite.config.ts:/app/vite.config.ts:ro
      - ./tailwind.config.js:/app/tailwind.config.js:ro
      - ./postcss.config.js:/app/postcss.config.js:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      # Keep container-owned node_modules
      - /app/node_modules
    # Reads PUBLIC_SUPABASE_ANON_KEY and ENCRYPTION_KEY from .env automatically
    environment:
      - PUBLIC_SUPABASE_URL=http://host.docker.internal:54321
      - PUBLIC_SUPABASE_ANON_KEY=${PUBLIC_SUPABASE_ANON_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DOCKER_ENV=1
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:5173']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
